<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinical Lab Test Directory</title>

  <!-- jQuery + DataTables CDN -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- Bootstrap for modal -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f7f7f9; margin:0; }
    .container { max-width:1200px; margin:auto; padding:18px; }
    h1 { font-size:1.5rem; margin-bottom:8px; color:#003366; }

    .top-controls { display:flex; gap:12px; align-items:center; margin:15px 0 18px; }
    #filter-specimen { min-width:220px }

    /* Table Styling */
    table.dataTable thead th {
      background:#003366;
      color:white;
      font-weight:600;
    }
    table.dataTable tbody tr:hover {
      background:#e6f7f9 !important;
      cursor:pointer;
    }

    /* Custom search input */
    #global-search {
      border:2px solid #17A2B8;
      box-shadow:none;
    }
    #global-search:focus {
      border-color:#FD7E14;
      box-shadow:0 0 4px #FD7E14;
    }

    /* Buttons (DataTables built-in) */
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background:#17A2B8 !important;
      color:white !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background:#FD7E14 !important;
      color:white !important;
    }

    /* Modal header with navy */
    .modal-header {
      background:#003366;
      color:white;
    }
    .modal-title { color:white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Clinical Laboratory Test Directory</h1>
    <p class="text-muted">Search, sort and click a test to view full details. Data pulled live from Google Sheet.</p>

    <div class="top-controls">
      <input id="global-search" class="form-control" placeholder="Search tests or keywords..." style="flex:1" />
      <select id="filter-specimen" class="form-select">
        <option value="">All Specimen Types</option>
      </select>
    </div>

    <table id="tests-table" class="display stripe hover" style="width:100%">
      <thead><tr id="table-headers"></tr></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-title">Test Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modal-body"></div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const SHEET_ID = '1nk-825z5rsdHK3MygYi6bMHlvNh79UHUY5XulTWZBKM';
  const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

  const res = await fetch(GVIZ_URL);
  const text = await res.text();
  const jsonText = text.replace(/^[^\(]*\(/, '').replace(/\);?$/, '');
  const sheet = JSON.parse(jsonText);
  const cols = sheet.table.cols.map(c => (c && c.label) ? c.label.trim() : '');
  const rows = sheet.table.rows;

  const headerTr = document.getElementById('table-headers');
  cols.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h || '(col)';
    headerTr.appendChild(th);
  });

  const specimenSet = new Set();
  const tbody = document.getElementById('table-body');

  rows.forEach(r => {
    const tr = document.createElement('tr');
    const dataObj = {};
    r.c.forEach((cell, ci) => {
      const value = (cell && cell.v !== null && cell.v !== undefined) ? String(cell.v) : '';
      dataObj[cols[ci] || `col${ci}`] = value;
      const td = document.createElement('td');
      td.innerHTML = value.replace(/\n/g,'<br/>');
      tr.appendChild(td);

      const headerLower = (cols[ci] || '').toLowerCase();
      if (headerLower.includes('specimen')) {
        if (value) value.split(/[,\/;]+/).forEach(v => specimenSet.add(v.trim()));
      }
    });
    tr.dataset.detail = JSON.stringify(dataObj);
    tr.addEventListener('click', () => showDetailsModal(dataObj));
    tbody.appendChild(tr);
  });

  const dt = $('#tests-table').DataTable({
    pageLength: 25,
    lengthMenu: [10,25,50,100],
    order: [[0,'asc']],
    columnDefs: [{ targets: '_all', defaultContent: '' }]
  });

  $('#global-search').on('input', function(){ dt.search(this.value).draw(); });

  const specimenArr = Array.from(specimenSet).filter(s => s).sort((a,b)=>a.localeCompare(b));
  const sel = document.getElementById('filter-specimen');
  specimenArr.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = s; sel.appendChild(opt);
  });
  sel.addEventListener('change', () => {
    const v = sel.value;
    if (!v) dt.search('').draw(); else dt.search(v).draw();
  });

  function showDetailsModal(obj) {
    document.getElementById('modal-title').textContent = obj[cols[0]] || 'Test Detail';
    const body = document.getElementById('modal-body');
    body.innerHTML = '';
    const table = document.createElement('table');
    table.className = 'table table-sm';
    const tbody2 = document.createElement('tbody');
    cols.forEach(k => {
      const tr = document.createElement('tr');
      const th = document.createElement('th');
      th.style.width = '30%'; th.textContent = k || '';
      const td = document.createElement('td');
      const v = (obj[k] !== undefined) ? obj[k] : '';
      td.innerHTML = v.replace(/\n/g,'<br/>');
      tr.appendChild(th); tr.appendChild(td); tbody2.appendChild(tr);
    });
    table.appendChild(tbody2);
    body.appendChild(table);
    new bootstrap.Modal(document.getElementById('detailModal')).show();
  }
})();
</script>
</body>
</html>
